test_types:
  id: '1511'
  test_type: Table_Freshness
  test_name_short: Table Freshness
  test_name_long: Stale Table Not Updated
  test_description: |-
    Confirms whether table has been updated based on data fingerprint
  except_message: |-
    Table has not been updated.
  measure_uom: Was Change Detected
  measure_uom_description: null
  selection_criteria: |-
    TEMPLATE
  generation_template: gen_Table_Freshness.sql
  dq_score_prevalence_formula: null
  dq_score_risk_factor: null
  column_name_prompt: |-
    null
  column_name_help: |-
    null
  default_parm_columns: history_calculation,history_lookback,subset_condition,custom_query
  default_parm_values: null
  default_parm_prompts: |-
    History Aggregate,History Lookback,Record Subset Condition,Fingerprint Expression
  default_parm_help: |-
    Aggregate calculation to be performed on the N lookback results|Last N tests to use for history aggregate calculation|Condition defining a subset of records in main table|String expression combining key column measures into a distinct representation of table state
  default_severity: Log
  run_type: QUERY
  test_scope: table
  dq_dimension: Recency
  health_dimension: Recency
  threshold_description: |-
    Most recent prior table fingerprint
  result_visualization: binary_chart
  result_visualization_params: '{"legend":{"labels":{"0":"Stale","1":"Updated"}}}'
  usage_notes: |-
    This test compares the current table fingerprint, calculated signature of column contents, to confirm that the table has been updated. The table fingerprint is derived from a set of values and aggregates from columns most likely to change. This test allows you to track the schedule and frequency of updates and refreshes to the table.
  active: Y
  cat_test_conditions: []
  target_data_lookups: []
  test_templates:
  - id: '2512'
    test_type: Table_Freshness
    sql_flavor: bigquery
    template: |-
      SELECT '{TEST_TYPE}' AS test_type,
             '{TEST_DEFINITION_ID}' AS test_definition_id,
             '{TEST_SUITE_ID}' AS test_suite_id,
             '{TEST_RUN_ID}' AS test_run_id,
             '{RUN_DATE}' AS test_time,
             '{SCHEMA_NAME}' AS schema_name,
             '{TABLE_NAME}' AS table_name,
             '{COLUMN_NAME_NO_QUOTES}' AS column_names,
             '{SKIP_ERRORS}' AS threshold_value,
             {SKIP_ERRORS} AS skip_errors,
             '{INPUT_PARAMETERS}' AS input_parameters,
             fingerprint AS result_signal,
             CASE 
               WHEN '{LOWER_TOLERANCE}' = 'NULL' OR fingerprint = '{LOWER_TOLERANCE}' THEN 0
               ELSE 1 
             END AS result_code,
             CASE
               WHEN '{LOWER_TOLERANCE}' = 'NULL' OR fingerprint = '{LOWER_TOLERANCE}' THEN 'No table change detected.'
               ELSE 'Table change detected.'
             END AS result_message,
             CASE
               WHEN '{LOWER_TOLERANCE}' = 'NULL' OR fingerprint = '{LOWER_TOLERANCE}' THEN 0
               ELSE 1
             END AS result_measure
      FROM (
        SELECT {CUSTOM_QUERY} AS fingerprint
        FROM `{SCHEMA_NAME}.{TABLE_NAME}`
        WHERE {SUBSET_CONDITION}
      ) test;
  - id: '2412'
    test_type: Table_Freshness
    sql_flavor: databricks
    template: |-
      SELECT '{TEST_TYPE}'   as test_type,
             '{TEST_DEFINITION_ID}' as test_definition_id,
             '{TEST_SUITE_ID}' as test_suite_id,
             '{TEST_RUN_ID}' as test_run_id,
             '{RUN_DATE}'    as test_time,
             '{SCHEMA_NAME}' as schema_name,
             '{TABLE_NAME}'  as table_name,
             '{COLUMN_NAME_NO_QUOTES}' as column_names,
             '{SKIP_ERRORS}' as threshold_value,
             {SKIP_ERRORS} as skip_errors,
             '{INPUT_PARAMETERS}' as input_parameters,
             fingerprint as result_signal,
             CASE 
               WHEN '{LOWER_TOLERANCE}' = 'NULL' OR fingerprint = '{LOWER_TOLERANCE}' THEN 0
               ELSE 1 
             END AS result_code,
             CASE
               WHEN '{LOWER_TOLERANCE}' = 'NULL' OR fingerprint = '{LOWER_TOLERANCE}' THEN 'No table change detected.'
               ELSE 'Table change detected.'
             END AS result_message,
             CASE
               WHEN '{LOWER_TOLERANCE}' = 'NULL' OR fingerprint = '{LOWER_TOLERANCE}' THEN 0
               ELSE 1
             END AS result_measure
        FROM ( SELECT {CUSTOM_QUERY} as fingerprint
                 FROM {QUOTE}{SCHEMA_NAME}{QUOTE}.{QUOTE}{TABLE_NAME}{QUOTE}
                WHERE {SUBSET_CONDITION}
             ) test;
  - id: '2212'
    test_type: Table_Freshness
    sql_flavor: mssql
    template: |-
      SELECT '{TEST_TYPE}'   as test_type,
             '{TEST_DEFINITION_ID}' as test_definition_id,
             '{TEST_SUITE_ID}' as test_suite_id,
             '{TEST_RUN_ID}' as test_run_id,
             '{RUN_DATE}'    as test_time,
             '{SCHEMA_NAME}' as schema_name,
             '{TABLE_NAME}'  as table_name,
             '{COLUMN_NAME_NO_QUOTES}' as column_names,
             '{SKIP_ERRORS}' as threshold_value,
             {SKIP_ERRORS} as skip_errors,
             '{INPUT_PARAMETERS}' as input_parameters,
             fingerprint as result_signal,
             CASE 
               WHEN '{LOWER_TOLERANCE}' = 'NULL' OR fingerprint = '{LOWER_TOLERANCE}' THEN 0
               ELSE 1 
             END AS result_code,
             CASE
               WHEN '{LOWER_TOLERANCE}' = 'NULL' OR fingerprint = '{LOWER_TOLERANCE}' THEN 'No table change detected.'
               ELSE 'Table change detected.'
             END AS result_message,
             CASE
               WHEN '{LOWER_TOLERANCE}' = 'NULL' OR fingerprint = '{LOWER_TOLERANCE}' THEN 0
               ELSE 1
             END AS result_measure
        FROM ( SELECT {CUSTOM_QUERY} as fingerprint
                 FROM "{SCHEMA_NAME}"."{TABLE_NAME}" WITH (NOLOCK)
                WHERE {SUBSET_CONDITION}
             ) test;
  - id: '2312'
    test_type: Table_Freshness
    sql_flavor: postgresql
    template: |-
      SELECT '{TEST_TYPE}'   as test_type,
             '{TEST_DEFINITION_ID}' as test_definition_id,
             '{TEST_SUITE_ID}' as test_suite_id,
             '{TEST_RUN_ID}' as test_run_id,
             '{RUN_DATE}'    as test_time,
             '{SCHEMA_NAME}' as schema_name,
             '{TABLE_NAME}'  as table_name,
             '{COLUMN_NAME_NO_QUOTES}' as column_names,
             '{SKIP_ERRORS}' as threshold_value,
             {SKIP_ERRORS} as skip_errors,
             '{INPUT_PARAMETERS}' as input_parameters,
             fingerprint as result_signal,
             CASE 
               WHEN '{LOWER_TOLERANCE}' = 'NULL' OR fingerprint = '{LOWER_TOLERANCE}' THEN 0
               ELSE 1 
             END AS result_code,
             CASE
               WHEN '{LOWER_TOLERANCE}' = 'NULL' OR fingerprint = '{LOWER_TOLERANCE}' THEN 'No table change detected.'
               ELSE 'Table change detected.'
             END AS result_message,
             CASE
               WHEN '{LOWER_TOLERANCE}' = 'NULL' OR fingerprint = '{LOWER_TOLERANCE}' THEN 0
               ELSE 1
             END AS result_measure
        FROM ( SELECT {CUSTOM_QUERY} as fingerprint
                 FROM {QUOTE}{SCHEMA_NAME}{QUOTE}.{QUOTE}{TABLE_NAME}{QUOTE}
                WHERE {SUBSET_CONDITION}
             ) test;
  - id: '2012'
    test_type: Table_Freshness
    sql_flavor: redshift
    template: |-
      SELECT '{TEST_TYPE}'   as test_type,
             '{TEST_DEFINITION_ID}' as test_definition_id,
             '{TEST_SUITE_ID}' as test_suite_id,
             '{TEST_RUN_ID}' as test_run_id,
             '{RUN_DATE}'    as test_time,
             '{SCHEMA_NAME}' as schema_name,
             '{TABLE_NAME}'  as table_name,
             '{COLUMN_NAME_NO_QUOTES}' as column_names,
             '{SKIP_ERRORS}' as threshold_value,
             {SKIP_ERRORS} as skip_errors,
             '{INPUT_PARAMETERS}' as input_parameters,
             fingerprint as result_signal,
             CASE 
               WHEN '{LOWER_TOLERANCE}' = 'NULL' OR fingerprint = '{LOWER_TOLERANCE}' THEN 0
               ELSE 1 
             END AS result_code,
             CASE
               WHEN '{LOWER_TOLERANCE}' = 'NULL' OR fingerprint = '{LOWER_TOLERANCE}' THEN 'No table change detected.'
               ELSE 'Table change detected.'
             END AS result_message,
             CASE
               WHEN '{LOWER_TOLERANCE}' = 'NULL' OR fingerprint = '{LOWER_TOLERANCE}' THEN 0
               ELSE 1
             END AS result_measure
        FROM ( SELECT {CUSTOM_QUERY} as fingerprint
                 FROM {QUOTE}{SCHEMA_NAME}{QUOTE}.{QUOTE}{TABLE_NAME}{QUOTE}
                WHERE {SUBSET_CONDITION}
             ) test;
  - id: '2512'
    test_type: Table_Freshness
    sql_flavor: redshift_spectrum
    template: |-
      SELECT '{TEST_TYPE}'   as test_type,
             '{TEST_DEFINITION_ID}' as test_definition_id,
             '{TEST_SUITE_ID}' as test_suite_id,
             '{TEST_RUN_ID}' as test_run_id,
             '{RUN_DATE}'    as test_time,
             '{SCHEMA_NAME}' as schema_name,
             '{TABLE_NAME}'  as table_name,
             '{COLUMN_NAME_NO_QUOTES}' as column_names,
             '{SKIP_ERRORS}' as threshold_value,
             {SKIP_ERRORS} as skip_errors,
             '{INPUT_PARAMETERS}' as input_parameters,
             fingerprint as result_signal,
             CASE 
               WHEN '{LOWER_TOLERANCE}' = 'NULL' OR fingerprint = '{LOWER_TOLERANCE}' THEN 0
               ELSE 1 
             END AS result_code,
             CASE
               WHEN '{LOWER_TOLERANCE}' = 'NULL' OR fingerprint = '{LOWER_TOLERANCE}' THEN 'No table change detected.'
               ELSE 'Table change detected.'
             END AS result_message,
             CASE
               WHEN '{LOWER_TOLERANCE}' = 'NULL' OR fingerprint = '{LOWER_TOLERANCE}' THEN 0
               ELSE 1
             END AS result_measure
        FROM ( SELECT {CUSTOM_QUERY} as fingerprint
                 FROM {QUOTE}{SCHEMA_NAME}{QUOTE}.{QUOTE}{TABLE_NAME}{QUOTE}
                WHERE {SUBSET_CONDITION}
             ) test;
  - id: '2112'
    test_type: Table_Freshness
    sql_flavor: snowflake
    template: |-
      SELECT '{TEST_TYPE}'   as test_type,
             '{TEST_DEFINITION_ID}' as test_definition_id,
             '{TEST_SUITE_ID}' as test_suite_id,
             '{TEST_RUN_ID}' as test_run_id,
             '{RUN_DATE}'    as test_time,
             '{SCHEMA_NAME}' as schema_name,
             '{TABLE_NAME}'  as table_name,
             '{COLUMN_NAME_NO_QUOTES}' as column_names,
             '{SKIP_ERRORS}' as threshold_value,
             {SKIP_ERRORS} as skip_errors,
             '{INPUT_PARAMETERS}' as input_parameters,
             fingerprint as result_signal,
             CASE 
               WHEN '{LOWER_TOLERANCE}' = 'NULL' OR fingerprint = '{LOWER_TOLERANCE}' THEN 0
               ELSE 1 
             END AS result_code,
             CASE
               WHEN '{LOWER_TOLERANCE}' = 'NULL' OR fingerprint = '{LOWER_TOLERANCE}' THEN 'No table change detected.'
               ELSE 'Table change detected.'
             END AS result_message,
             CASE
               WHEN '{LOWER_TOLERANCE}' = 'NULL' OR fingerprint = '{LOWER_TOLERANCE}' THEN 0
               ELSE 1
             END AS result_measure
        FROM ( SELECT {CUSTOM_QUERY} as fingerprint
                 FROM {QUOTE}{SCHEMA_NAME}{QUOTE}.{QUOTE}{TABLE_NAME}{QUOTE}
                WHERE {SUBSET_CONDITION}
             ) test;
