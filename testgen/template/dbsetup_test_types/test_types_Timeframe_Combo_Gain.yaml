test_types:
  id: '1508'
  test_type: Timeframe_Combo_Gain
  test_name_short: Timeframe No Drops
  test_name_long: Latest timeframe has at least all value combinations from prior
    period
  test_description: |-
    Tests that column values in most recent time-window include at least same as prior time window
  except_message: |-
    Column values in most recent time-window don't include all values in prior window.
  measure_uom: Mismatched values
  measure_uom_description: null
  selection_criteria: null
  dq_score_prevalence_formula: |-
    ({RESULT_MEASURE}-{THRESHOLD_VALUE})::FLOAT/NULLIF({RECORD_CT}::FLOAT, 0)
  dq_score_risk_factor: '1.0'
  column_name_prompt: |-
    Categorical Column List
  column_name_help: |-
    Specify one or more Categorical columns, separated by commas. Make sure not to use continuous measurements here. Do not use numeric values unless they represent discrete categories.
  default_parm_columns: window_date_column,window_days,subset_condition
  default_parm_values: null
  default_parm_prompts: |-
    Date Column for Time Windows,Time Window in Days,Record Subset Condition
  default_parm_help: |-
    The date column used to define the time windows. This must be a DATE or DATETIME type.|Length in days of the time window. The test will compare the most recent period of days to the prior period of the same duration.|Condition defining a subset of records in main table to evaluate, written like a condition within a SQL WHERE clause - OPTIONAL
  default_severity: Fail
  run_type: QUERY
  test_scope: referential
  dq_dimension: Consistency
  health_dimension: Data Drift
  threshold_description: |-
    Expected count of missing value combinations
  result_visualization: line_chart
  result_visualization_params: null
  usage_notes: |-
    This test checks a single transactional table to verify that categorical values or combinations that are present in the most recent time window you define include at least all those found in the prior time window of the same duration. Missing values in the latest time window will trigger the test to fail. New values are permitted. Use this test to confirm that codes or categories are not lost across successive time periods in a transactional table.
  active: Y
  cat_test_conditions: []
  target_data_lookups:
  - id: '1406'
    test_id: '1508'
    test_type: Timeframe_Combo_Gain
    sql_flavor: bigquery
    lookup_type: null
    lookup_query: |-
      SELECT {COLUMN_NAME_NO_QUOTES}
      FROM `{TARGET_SCHEMA}`.`{TABLE_NAME}`
      WHERE {SUBSET_CONDITION}
        AND {WINDOW_DATE_COLUMN} >= DATE_SUB((SELECT MAX({WINDOW_DATE_COLUMN}) FROM `{TARGET_SCHEMA}`.`{TABLE_NAME}`), INTERVAL 2 * {WINDOW_DAYS} DAY)
        AND {WINDOW_DATE_COLUMN} < DATE_SUB((SELECT MAX({WINDOW_DATE_COLUMN}) FROM `{TARGET_SCHEMA}`.`{TABLE_NAME}`), INTERVAL {WINDOW_DAYS} DAY)
      GROUP BY {COLUMN_NAME_NO_QUOTES}
      EXCEPT DISTINCT
      SELECT {COLUMN_NAME_NO_QUOTES}
      FROM `{TARGET_SCHEMA}`.`{TABLE_NAME}`
      WHERE {SUBSET_CONDITION}
        AND {WINDOW_DATE_COLUMN} >= DATE_SUB((SELECT MAX({WINDOW_DATE_COLUMN}) FROM `{TARGET_SCHEMA}`.`{TABLE_NAME}`), INTERVAL {WINDOW_DAYS} DAY)
      GROUP BY {COLUMN_NAME_NO_QUOTES}
      LIMIT {LIMIT};
    error_type: Test Results
  - id: '1263'
    test_id: '1508'
    test_type: Timeframe_Combo_Gain
    sql_flavor: mssql
    lookup_type: null
    lookup_query: |-
      SELECT TOP {LIMIT} {COLUMN_NAME_NO_QUOTES}
        FROM "{TARGET_SCHEMA}"."{TABLE_NAME}"
       WHERE {SUBSET_CONDITION}
         AND {WINDOW_DATE_COLUMN} >= DATEADD("day",  - 2 * {WINDOW_DAYS}, (SELECT MAX({WINDOW_DATE_COLUMN}) FROM "{TARGET_SCHEMA}"."{TABLE_NAME}"))
         AND {WINDOW_DATE_COLUMN} <  DATEADD("day", - {WINDOW_DAYS}, (SELECT MAX({WINDOW_DATE_COLUMN}) FROM "{TARGET_SCHEMA}"."{TABLE_NAME}"))
      GROUP BY {COLUMN_NAME_NO_QUOTES}
       EXCEPT
      SELECT {COLUMN_NAME_NO_QUOTES}
        FROM "{TARGET_SCHEMA}"."{TABLE_NAME}"
       WHERE {SUBSET_CONDITION}
         AND {WINDOW_DATE_COLUMN} >= DATEADD("day", - {WINDOW_DAYS}, (SELECT MAX({WINDOW_DATE_COLUMN}) FROM "{TARGET_SCHEMA}"."{TABLE_NAME}"))
      GROUP BY {COLUMN_NAME_NO_QUOTES}
    error_type: Test Results
  - id: '1264'
    test_id: '1508'
    test_type: Timeframe_Combo_Gain
    sql_flavor: postgresql
    lookup_type: null
    lookup_query: |-
      SELECT {COLUMN_NAME_NO_QUOTES}
        FROM "{TARGET_SCHEMA}"."{TABLE_NAME}"
       WHERE {SUBSET_CONDITION}
         AND {WINDOW_DATE_COLUMN} >= (SELECT MAX({WINDOW_DATE_COLUMN}) FROM "{TARGET_SCHEMA}"."{TABLE_NAME}") - 2 * {WINDOW_DAYS}
         AND {WINDOW_DATE_COLUMN} < (SELECT MAX({WINDOW_DATE_COLUMN}) FROM "{TARGET_SCHEMA}"."{TABLE_NAME}") - {WINDOW_DAYS}
      GROUP BY {COLUMN_NAME_NO_QUOTES}
       EXCEPT
      SELECT {COLUMN_NAME_NO_QUOTES}
        FROM "{TARGET_SCHEMA}"."{TABLE_NAME}"
       WHERE {SUBSET_CONDITION}
         AND {WINDOW_DATE_COLUMN} >= (SELECT MAX({WINDOW_DATE_COLUMN}) FROM "{TARGET_SCHEMA}"."{TABLE_NAME}") - {WINDOW_DAYS}
      GROUP BY {COLUMN_NAME_NO_QUOTES}
      LIMIT {LIMIT};
    error_type: Test Results
  - id: '1261'
    test_id: '1508'
    test_type: Timeframe_Combo_Gain
    sql_flavor: redshift
    lookup_type: null
    lookup_query: |-
      SELECT {COLUMN_NAME_NO_QUOTES}
        FROM "{TARGET_SCHEMA}"."{TABLE_NAME}"
       WHERE {SUBSET_CONDITION}
         AND {WINDOW_DATE_COLUMN} >= (SELECT MAX({WINDOW_DATE_COLUMN}) FROM "{TARGET_SCHEMA}"."{TABLE_NAME}") - 2 * {WINDOW_DAYS}
         AND {WINDOW_DATE_COLUMN} < (SELECT MAX({WINDOW_DATE_COLUMN}) FROM "{TARGET_SCHEMA}"."{TABLE_NAME}") - {WINDOW_DAYS}
      GROUP BY {COLUMN_NAME_NO_QUOTES}
       EXCEPT
      SELECT {COLUMN_NAME_NO_QUOTES}
        FROM "{TARGET_SCHEMA}"."{TABLE_NAME}"
       WHERE {SUBSET_CONDITION}
         AND {WINDOW_DATE_COLUMN} >= (SELECT MAX({WINDOW_DATE_COLUMN}) FROM "{TARGET_SCHEMA}"."{TABLE_NAME}") - {WINDOW_DAYS}
      GROUP BY {COLUMN_NAME_NO_QUOTES}
      LIMIT {LIMIT};
    error_type: Test Results
  - id: '1468'
    test_id: '1508'
    test_type: Timeframe_Combo_Gain
    sql_flavor: redshift_spectrum
    lookup_type: null
    lookup_query: |-
      SELECT {COLUMN_NAME_NO_QUOTES}
        FROM "{TARGET_SCHEMA}"."{TABLE_NAME}"
       WHERE {SUBSET_CONDITION}
         AND {WINDOW_DATE_COLUMN} >= (SELECT MAX({WINDOW_DATE_COLUMN}) FROM "{TARGET_SCHEMA}"."{TABLE_NAME}") - 2 * {WINDOW_DAYS}
         AND {WINDOW_DATE_COLUMN} < (SELECT MAX({WINDOW_DATE_COLUMN}) FROM "{TARGET_SCHEMA}"."{TABLE_NAME}") - {WINDOW_DAYS}
      GROUP BY {COLUMN_NAME_NO_QUOTES}
       EXCEPT
      SELECT {COLUMN_NAME_NO_QUOTES}
        FROM "{TARGET_SCHEMA}"."{TABLE_NAME}"
       WHERE {SUBSET_CONDITION}
         AND {WINDOW_DATE_COLUMN} >= (SELECT MAX({WINDOW_DATE_COLUMN}) FROM "{TARGET_SCHEMA}"."{TABLE_NAME}") - {WINDOW_DAYS}
      GROUP BY {COLUMN_NAME_NO_QUOTES}
      LIMIT {LIMIT};
    error_type: Test Results
  - id: '1262'
    test_id: '1508'
    test_type: Timeframe_Combo_Gain
    sql_flavor: snowflake
    lookup_type: null
    lookup_query: |-
      SELECT {COLUMN_NAME_NO_QUOTES}
        FROM "{TARGET_SCHEMA}"."{TABLE_NAME}"
       WHERE {SUBSET_CONDITION}
         AND {WINDOW_DATE_COLUMN} >= (SELECT MAX({WINDOW_DATE_COLUMN}) FROM "{TARGET_SCHEMA}"."{TABLE_NAME}") - 2 * {WINDOW_DAYS}
         AND {WINDOW_DATE_COLUMN} < (SELECT MAX({WINDOW_DATE_COLUMN}) FROM "{TARGET_SCHEMA}"."{TABLE_NAME}") - {WINDOW_DAYS}
      GROUP BY {COLUMN_NAME_NO_QUOTES}
       EXCEPT
      SELECT {COLUMN_NAME_NO_QUOTES}
        FROM "{TARGET_SCHEMA}"."{TABLE_NAME}"
       WHERE {SUBSET_CONDITION}
         AND {WINDOW_DATE_COLUMN} >= (SELECT MAX({WINDOW_DATE_COLUMN}) FROM "{TARGET_SCHEMA}"."{TABLE_NAME}") - {WINDOW_DAYS}
      GROUP BY {COLUMN_NAME_NO_QUOTES}
      LIMIT {LIMIT};
    error_type: Test Results
  test_templates:
  - id: '2507'
    test_type: Timeframe_Combo_Gain
    sql_flavor: bigquery
    template_name: ex_window_match_no_drops_bigquery.sql
  - id: '2407'
    test_type: Timeframe_Combo_Gain
    sql_flavor: databricks
    template_name: ex_window_match_no_drops_databricks.sql
  - id: '2207'
    test_type: Timeframe_Combo_Gain
    sql_flavor: mssql
    template_name: ex_window_match_no_drops_generic.sql
  - id: '2307'
    test_type: Timeframe_Combo_Gain
    sql_flavor: postgresql
    template_name: ex_window_match_no_drops_postgresql.sql
  - id: '2007'
    test_type: Timeframe_Combo_Gain
    sql_flavor: redshift
    template_name: ex_window_match_no_drops_generic.sql
  - id: '2507'
    test_type: Timeframe_Combo_Gain
    sql_flavor: redshift_spectrum
    template_name: ex_window_match_no_drops_generic.sql
  - id: '2107'
    test_type: Timeframe_Combo_Gain
    sql_flavor: snowflake
    template_name: ex_window_match_no_drops_generic.sql
