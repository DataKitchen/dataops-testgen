test_types:
  id: '1515'
  test_type: Freshness_Trend
  test_name_short: Freshness
  test_name_long: Table updated within expected time window
  test_description: |-
    Confirms whether table has been updated within expected time window
  except_message: |-
    Table has not been updated within expected time window.
  measure_uom: Interval since last update
  measure_uom_description: null
  selection_criteria: |-
    TEMPLATE
  generation_template: gen_Freshness_Trend.sql
  dq_score_prevalence_formula: null
  dq_score_risk_factor: null
  column_name_prompt: |-
    null
  column_name_help: |-
    null
  default_parm_columns: subset_condition,custom_query,history_calculation,history_calculation_upper,history_lookback
  default_parm_values: null
  default_parm_prompts: |-
    Record Subset Condition,Fingerprint Expression,Lower Bound,Upper Bound,History Lookback
  default_parm_help: |-
    Aggregate calculation to be performed on the N lookback results|Last N tests to use for history aggregate calculation|Condition defining a subset of records in main table|String expression combining key column measures into a distinct representation of table state
  default_severity: Fail
  run_type: QUERY
  test_scope: table
  dq_dimension: Recency
  health_dimension: Recency
  threshold_description: |-
    Expected time window
  result_visualization: binary_chart
  result_visualization_params: '{"legend":{"labels":{"0":"Not updated on time","1":"Updated"}}}'
  usage_notes: |-
    This test compares the current table fingerprint, calculated signature of column contents, to confirm that the table has been updated within the expectd time window. The table fingerprint is derived from a set of values and aggregates from columns most likely to change. This test allows you to track the schedule and frequency of updates and refreshes to the table.
  active: Y
  cat_test_conditions: []
  target_data_lookups: []
  test_templates:
  - id: '2517'
    test_type: Freshness_Trend
    sql_flavor: bigquery
    template: |-
      WITH fingerprint_data AS (
        SELECT {CUSTOM_QUERY} AS fingerprint
        FROM `{SCHEMA_NAME}.{TABLE_NAME}`
        WHERE {SUBSET_CONDITION}
      ),
      test_data AS (
        SELECT
          fingerprint,
          CASE
            WHEN fingerprint <> '{BASELINE_VALUE}' THEN 0
            ELSE DATETIME_DIFF(DATETIME('{RUN_DATE}'), DATETIME(NULLIF('{BASELINE_SUM}', '')), MINUTE)
          END AS interval_minutes
        FROM fingerprint_data
      )
      SELECT '{TEST_TYPE}' AS test_type,
        '{TEST_DEFINITION_ID}' AS test_definition_id,
        '{TEST_SUITE_ID}' AS test_suite_id,
        '{TEST_RUN_ID}' AS test_run_id,
        '{RUN_DATE}' AS test_time,
        '{SCHEMA_NAME}' AS schema_name,
        '{TABLE_NAME}' AS table_name,
        '{COLUMN_NAME_NO_QUOTES}' AS column_names,
        '{SKIP_ERRORS}' AS threshold_value,
        {SKIP_ERRORS} AS skip_errors,
        '{INPUT_PARAMETERS}' AS input_parameters,
        fingerprint AS result_measure,
        CASE
          -- Training mode: tolerances not yet calculated
          WHEN {LOWER_TOLERANCE} IS NULL OR {UPPER_TOLERANCE} IS NULL THEN -1
          -- No change to table, and we're beyond time range: LATE
          WHEN fingerprint = '{BASELINE_VALUE}' AND interval_minutes > {UPPER_TOLERANCE} THEN 0
          -- Table changed outside time range: UNEXPECTED
          WHEN fingerprint <> '{BASELINE_VALUE}'
            AND NOT interval_minutes BETWEEN {LOWER_TOLERANCE} AND {UPPER_TOLERANCE} THEN 0
          ELSE 1
        END AS result_code,
        'Table change detected: ' || CASE WHEN fingerprint <> '{BASELINE_VALUE}' THEN 'Yes' ELSE 'No' END
          || CASE
            WHEN fingerprint <> '{BASELINE_VALUE}' AND interval_minutes BETWEEN {LOWER_TOLERANCE} AND {UPPER_TOLERANCE} THEN '. On time.'
            WHEN fingerprint <> '{BASELINE_VALUE}' AND interval_minutes < {LOWER_TOLERANCE} THEN '. Earlier than expected.'
            WHEN fingerprint <> '{BASELINE_VALUE}' AND interval_minutes > {UPPER_TOLERANCE} THEN '. Later than expected.'
            WHEN fingerprint = '{BASELINE_VALUE}' AND interval_minutes > {UPPER_TOLERANCE} THEN '. Late.'
            ELSE ''
          END AS result_message,
        COALESCE(CAST(interval_minutes AS STRING), 'Unknown') AS result_signal
      FROM test_data;
  - id: '2417'
    test_type: Freshness_Trend
    sql_flavor: databricks
    template: |-
      WITH fingerprint_data AS (
        SELECT {CUSTOM_QUERY} AS fingerprint
        FROM `{SCHEMA_NAME}`.`{TABLE_NAME}`
        WHERE {SUBSET_CONDITION}
      ),
      test_data AS (
        SELECT
          fingerprint,
          CASE
            WHEN fingerprint <> '{BASELINE_VALUE}' THEN 0
            ELSE DATEDIFF(MINUTE, TO_TIMESTAMP(NULLIF('{BASELINE_SUM}', '')), TIMESTAMP '{RUN_DATE}')
          END AS interval_minutes
        FROM fingerprint_data
      )
      SELECT '{TEST_TYPE}' AS test_type,
        '{TEST_DEFINITION_ID}' AS test_definition_id,
        '{TEST_SUITE_ID}' AS test_suite_id,
        '{TEST_RUN_ID}' AS test_run_id,
        '{RUN_DATE}' AS test_time,
        '{SCHEMA_NAME}' AS schema_name,
        '{TABLE_NAME}' AS table_name,
        '{COLUMN_NAME_NO_QUOTES}' AS column_names,
        '{SKIP_ERRORS}' AS threshold_value,
        {SKIP_ERRORS} AS skip_errors,
        '{INPUT_PARAMETERS}' AS input_parameters,
        fingerprint AS result_measure,
        CASE
          -- Training mode: tolerances not yet calculated
          WHEN {LOWER_TOLERANCE} IS NULL OR {UPPER_TOLERANCE} IS NULL THEN -1
          -- No change to table, and we're beyond time range: LATE
          WHEN fingerprint = '{BASELINE_VALUE}' AND interval_minutes > {UPPER_TOLERANCE} THEN 0
          -- Table changed outside time range: UNEXPECTED
          WHEN fingerprint <> '{BASELINE_VALUE}'
            AND NOT interval_minutes BETWEEN {LOWER_TOLERANCE} AND {UPPER_TOLERANCE} THEN 0
          ELSE 1
        END AS result_code,
        'Table change detected: ' || CASE WHEN fingerprint <> '{BASELINE_VALUE}' THEN 'Yes' ELSE 'No' END
          || CASE
            WHEN fingerprint <> '{BASELINE_VALUE}' AND interval_minutes BETWEEN {LOWER_TOLERANCE} AND {UPPER_TOLERANCE} THEN '. On time.'
            WHEN fingerprint <> '{BASELINE_VALUE}' AND interval_minutes < {LOWER_TOLERANCE} THEN '. Earlier than expected.'
            WHEN fingerprint <> '{BASELINE_VALUE}' AND interval_minutes > {UPPER_TOLERANCE} THEN '. Later than expected.'
            WHEN fingerprint = '{BASELINE_VALUE}' AND interval_minutes > {UPPER_TOLERANCE} THEN '. Late.'
            ELSE ''
          END AS result_message,
        COALESCE(interval_minutes::STRING, 'Unknown') AS result_signal
      FROM test_data;
  - id: '2217'
    test_type: Freshness_Trend
    sql_flavor: mssql
    template: |-
      WITH fingerprint_data AS (
        SELECT {CUSTOM_QUERY} AS fingerprint
        FROM "{SCHEMA_NAME}"."{TABLE_NAME}" WITH (NOLOCK)
        WHERE {SUBSET_CONDITION}
      ),
      test_data AS (
        SELECT
          fingerprint,
          CASE
            WHEN fingerprint <> '{BASELINE_VALUE}' THEN 0
            ELSE DATEDIFF(MINUTE, CAST(NULLIF('{BASELINE_SUM}', '') AS DATETIME2), CAST('{RUN_DATE}' AS DATETIME2))
          END AS interval_minutes
        FROM fingerprint_data
      )
      SELECT '{TEST_TYPE}' AS test_type,
        '{TEST_DEFINITION_ID}' AS test_definition_id,
        '{TEST_SUITE_ID}' AS test_suite_id,
        '{TEST_RUN_ID}' AS test_run_id,
        '{RUN_DATE}' AS test_time,
        '{SCHEMA_NAME}' AS schema_name,
        '{TABLE_NAME}' AS table_name,
        '{COLUMN_NAME_NO_QUOTES}' AS column_names,
        '{SKIP_ERRORS}' AS threshold_value,
        {SKIP_ERRORS} AS skip_errors,
        '{INPUT_PARAMETERS}' AS input_parameters,
        fingerprint AS result_measure,
        CASE
          -- Training mode: tolerances not yet calculated
          WHEN {LOWER_TOLERANCE} IS NULL OR {UPPER_TOLERANCE} IS NULL THEN -1
          -- No change to table, and we're beyond time range: LATE
          WHEN fingerprint = '{BASELINE_VALUE}' AND interval_minutes > {UPPER_TOLERANCE} THEN 0
          -- Table changed outside time range: UNEXPECTED
          WHEN fingerprint <> '{BASELINE_VALUE}'
            AND NOT interval_minutes BETWEEN {LOWER_TOLERANCE} AND {UPPER_TOLERANCE} THEN 0
          ELSE 1
        END AS result_code,
        'Table change detected: ' + CASE WHEN fingerprint <> '{BASELINE_VALUE}' THEN 'Yes' ELSE 'No' END
          + CASE
            WHEN fingerprint <> '{BASELINE_VALUE}' AND interval_minutes BETWEEN {LOWER_TOLERANCE} AND {UPPER_TOLERANCE} THEN '. On time.'
            WHEN fingerprint <> '{BASELINE_VALUE}' AND interval_minutes < {LOWER_TOLERANCE} THEN '. Earlier than expected.'
            WHEN fingerprint <> '{BASELINE_VALUE}' AND interval_minutes > {UPPER_TOLERANCE} THEN '. Later than expected.'
            WHEN fingerprint = '{BASELINE_VALUE}' AND interval_minutes > {UPPER_TOLERANCE} THEN '. Late.'
            ELSE ''
          END AS result_message,
        COALESCE(CAST(interval_minutes AS VARCHAR), 'Unknown') AS result_signal
      FROM test_data;
  - id: '2317'
    test_type: Freshness_Trend
    sql_flavor: postgresql
    template: |-
      WITH fingerprint_data AS (
        SELECT {CUSTOM_QUERY} AS fingerprint
        FROM "{SCHEMA_NAME}"."{TABLE_NAME}"
        WHERE {SUBSET_CONDITION}
      ),
      test_data AS (
        SELECT
          fingerprint,
          CASE
            WHEN fingerprint <> '{BASELINE_VALUE}' THEN 0
            ELSE (EXTRACT(EPOCH FROM ('{RUN_DATE}'::TIMESTAMP - NULLIF('{BASELINE_SUM}', '')::TIMESTAMP)) / 60)::INTEGER
          END AS interval_minutes
        FROM fingerprint_data
      )
      SELECT '{TEST_TYPE}' AS test_type,
        '{TEST_DEFINITION_ID}' AS test_definition_id,
        '{TEST_SUITE_ID}' AS test_suite_id,
        '{TEST_RUN_ID}' AS test_run_id,
        '{RUN_DATE}' AS test_time,
        '{SCHEMA_NAME}' AS schema_name,
        '{TABLE_NAME}' AS table_name,
        '{COLUMN_NAME_NO_QUOTES}' AS column_names,
        '{SKIP_ERRORS}' AS threshold_value,
        {SKIP_ERRORS} AS skip_errors,
        '{INPUT_PARAMETERS}' AS input_parameters,
        fingerprint AS result_measure,
        CASE
          -- Training mode: tolerances not yet calculated
          WHEN {LOWER_TOLERANCE} IS NULL OR {UPPER_TOLERANCE} IS NULL THEN -1
          -- No change to table, and we're beyond time range: LATE
          WHEN fingerprint = '{BASELINE_VALUE}' AND interval_minutes > {UPPER_TOLERANCE} THEN 0
          -- Table changed outside time range: UNEXPECTED
          WHEN fingerprint <> '{BASELINE_VALUE}'
            AND NOT interval_minutes BETWEEN {LOWER_TOLERANCE} AND {UPPER_TOLERANCE} THEN 0
          ELSE 1
        END AS result_code,
        'Table change detected: ' || CASE WHEN fingerprint <> '{BASELINE_VALUE}' THEN 'Yes' ELSE 'No' END
          || CASE
            WHEN fingerprint <> '{BASELINE_VALUE}' AND interval_minutes BETWEEN {LOWER_TOLERANCE} AND {UPPER_TOLERANCE} THEN '. On time.'
            WHEN fingerprint <> '{BASELINE_VALUE}' AND interval_minutes < {LOWER_TOLERANCE} THEN '. Earlier than expected.'
            WHEN fingerprint <> '{BASELINE_VALUE}' AND interval_minutes > {UPPER_TOLERANCE} THEN '. Later than expected.'
            WHEN fingerprint = '{BASELINE_VALUE}' AND interval_minutes > {UPPER_TOLERANCE} THEN '. Late.'
            ELSE ''
          END AS result_message,
        COALESCE(interval_minutes::TEXT, 'Unknown') AS result_signal
      FROM test_data;
  - id: '2017'
    test_type: Freshness_Trend
    sql_flavor: redshift
    template: |-
      WITH fingerprint_data AS (
        SELECT {CUSTOM_QUERY} AS fingerprint
        FROM "{SCHEMA_NAME}"."{TABLE_NAME}"
        WHERE {SUBSET_CONDITION}
      ),
      test_data AS (
        SELECT
          fingerprint,
          CASE
            WHEN fingerprint <> '{BASELINE_VALUE}' THEN 0
            ELSE DATEDIFF(MINUTE, NULLIF('{BASELINE_SUM}', '')::TIMESTAMP, '{RUN_DATE}'::TIMESTAMP)
          END AS interval_minutes
        FROM fingerprint_data
      )
      SELECT '{TEST_TYPE}' AS test_type,
        '{TEST_DEFINITION_ID}' AS test_definition_id,
        '{TEST_SUITE_ID}' AS test_suite_id,
        '{TEST_RUN_ID}' AS test_run_id,
        '{RUN_DATE}' AS test_time,
        '{SCHEMA_NAME}' AS schema_name,
        '{TABLE_NAME}' AS table_name,
        '{COLUMN_NAME_NO_QUOTES}' AS column_names,
        '{SKIP_ERRORS}' AS threshold_value,
        {SKIP_ERRORS} AS skip_errors,
        '{INPUT_PARAMETERS}' AS input_parameters,
        fingerprint AS result_measure,
        CASE
          -- Training mode: tolerances not yet calculated
          WHEN {LOWER_TOLERANCE} IS NULL OR {UPPER_TOLERANCE} IS NULL THEN -1
          -- No change to table, and we're beyond time range: LATE
          WHEN fingerprint = '{BASELINE_VALUE}' AND interval_minutes > {UPPER_TOLERANCE} THEN 0
          -- Table changed outside time range: UNEXPECTED
          WHEN fingerprint <> '{BASELINE_VALUE}'
            AND NOT interval_minutes BETWEEN {LOWER_TOLERANCE} AND {UPPER_TOLERANCE} THEN 0
          ELSE 1
        END AS result_code,
        'Table change detected: ' || CASE WHEN fingerprint <> '{BASELINE_VALUE}' THEN 'Yes' ELSE 'No' END
          || CASE
            WHEN fingerprint <> '{BASELINE_VALUE}' AND interval_minutes BETWEEN {LOWER_TOLERANCE} AND {UPPER_TOLERANCE} THEN '. On time.'
            WHEN fingerprint <> '{BASELINE_VALUE}' AND interval_minutes < {LOWER_TOLERANCE} THEN '. Earlier than expected.'
            WHEN fingerprint <> '{BASELINE_VALUE}' AND interval_minutes > {UPPER_TOLERANCE} THEN '. Later than expected.'
            WHEN fingerprint = '{BASELINE_VALUE}' AND interval_minutes > {UPPER_TOLERANCE} THEN '. Late.'
            ELSE ''
          END AS result_message,
        COALESCE(interval_minutes::VARCHAR, 'Unknown') AS result_signal
      FROM test_data;
  - id: '2517'
    test_type: Freshness_Trend
    sql_flavor: redshift_spectrum
    template: |-
      WITH fingerprint_data AS (
        SELECT {CUSTOM_QUERY} AS fingerprint
        FROM "{SCHEMA_NAME}"."{TABLE_NAME}"
        WHERE {SUBSET_CONDITION}
      ),
      test_data AS (
        SELECT
          fingerprint,
          CASE
            WHEN fingerprint <> '{BASELINE_VALUE}' THEN 0
            ELSE DATEDIFF(MINUTE, NULLIF('{BASELINE_SUM}', '')::TIMESTAMP, '{RUN_DATE}'::TIMESTAMP)
          END AS interval_minutes
        FROM fingerprint_data
      )
      SELECT '{TEST_TYPE}' AS test_type,
        '{TEST_DEFINITION_ID}' AS test_definition_id,
        '{TEST_SUITE_ID}' AS test_suite_id,
        '{TEST_RUN_ID}' AS test_run_id,
        '{RUN_DATE}' AS test_time,
        '{SCHEMA_NAME}' AS schema_name,
        '{TABLE_NAME}' AS table_name,
        '{COLUMN_NAME_NO_QUOTES}' AS column_names,
        '{SKIP_ERRORS}' AS threshold_value,
        {SKIP_ERRORS} AS skip_errors,
        '{INPUT_PARAMETERS}' AS input_parameters,
        fingerprint AS result_measure,
        CASE
          -- Training mode: tolerances not yet calculated
          WHEN {LOWER_TOLERANCE} IS NULL OR {UPPER_TOLERANCE} IS NULL THEN -1
          -- No change to table, and we're beyond time range: LATE
          WHEN fingerprint = '{BASELINE_VALUE}' AND interval_minutes > {UPPER_TOLERANCE} THEN 0
          -- Table changed outside time range: UNEXPECTED
          WHEN fingerprint <> '{BASELINE_VALUE}'
            AND NOT interval_minutes BETWEEN {LOWER_TOLERANCE} AND {UPPER_TOLERANCE} THEN 0
          ELSE 1
        END AS result_code,
        'Table change detected: ' || CASE WHEN fingerprint <> '{BASELINE_VALUE}' THEN 'Yes' ELSE 'No' END
          || CASE
            WHEN fingerprint <> '{BASELINE_VALUE}' AND interval_minutes BETWEEN {LOWER_TOLERANCE} AND {UPPER_TOLERANCE} THEN '. On time.'
            WHEN fingerprint <> '{BASELINE_VALUE}' AND interval_minutes < {LOWER_TOLERANCE} THEN '. Earlier than expected.'
            WHEN fingerprint <> '{BASELINE_VALUE}' AND interval_minutes > {UPPER_TOLERANCE} THEN '. Later than expected.'
            WHEN fingerprint = '{BASELINE_VALUE}' AND interval_minutes > {UPPER_TOLERANCE} THEN '. Late.'
            ELSE ''
          END AS result_message,
        COALESCE(interval_minutes::VARCHAR, 'Unknown') AS result_signal
      FROM test_data;
  - id: '2117'
    test_type: Freshness_Trend
    sql_flavor: snowflake
    template: |-
      WITH fingerprint_data AS (
        SELECT {CUSTOM_QUERY} AS fingerprint
        FROM "{SCHEMA_NAME}"."{TABLE_NAME}"
        WHERE {SUBSET_CONDITION}
      ),
      test_data AS (
        SELECT
          fingerprint,
          CASE
            WHEN fingerprint <> '{BASELINE_VALUE}' THEN 0
            ELSE DATEDIFF(MINUTE, NULLIF('{BASELINE_SUM}', '')::TIMESTAMP, '{RUN_DATE}'::TIMESTAMP)
          END AS interval_minutes
        FROM fingerprint_data
      )
      SELECT '{TEST_TYPE}' AS test_type,
        '{TEST_DEFINITION_ID}' AS test_definition_id,
        '{TEST_SUITE_ID}' AS test_suite_id,
        '{TEST_RUN_ID}' AS test_run_id,
        '{RUN_DATE}' AS test_time,
        '{SCHEMA_NAME}' AS schema_name,
        '{TABLE_NAME}' AS table_name,
        '{COLUMN_NAME_NO_QUOTES}' AS column_names,
        '{SKIP_ERRORS}' AS threshold_value,
        {SKIP_ERRORS} AS skip_errors,
        '{INPUT_PARAMETERS}' AS input_parameters,
        fingerprint AS result_measure,
        CASE
          -- Training mode: tolerances not yet calculated
          WHEN {LOWER_TOLERANCE} IS NULL OR {UPPER_TOLERANCE} IS NULL THEN -1
          -- No change to table, and we're beyond time range: LATE
          WHEN fingerprint = '{BASELINE_VALUE}' AND interval_minutes > {UPPER_TOLERANCE} THEN 0
          -- Table changed outside time range: UNEXPECTED
          WHEN fingerprint <> '{BASELINE_VALUE}'
            AND NOT interval_minutes BETWEEN {LOWER_TOLERANCE} AND {UPPER_TOLERANCE} THEN 0
          ELSE 1
        END AS result_code,
        'Table change detected: ' || CASE WHEN fingerprint <> '{BASELINE_VALUE}' THEN 'Yes' ELSE 'No' END
          || CASE
            WHEN fingerprint <> '{BASELINE_VALUE}' AND interval_minutes BETWEEN {LOWER_TOLERANCE} AND {UPPER_TOLERANCE} THEN '. On time.'
            WHEN fingerprint <> '{BASELINE_VALUE}' AND interval_minutes < {LOWER_TOLERANCE} THEN '. Earlier than expected.'
            WHEN fingerprint <> '{BASELINE_VALUE}' AND interval_minutes > {UPPER_TOLERANCE} THEN '. Later than expected.'
            WHEN fingerprint = '{BASELINE_VALUE}' AND interval_minutes > {UPPER_TOLERANCE} THEN '. Late.'
            ELSE ''
          END AS result_message,
        COALESCE(interval_minutes::VARCHAR, 'Unknown') AS result_signal
      FROM test_data;
