WITH filtered_defs AS (
  -- Step 1: Filter definitions first to minimize join surface area
  SELECT id,
    test_suite_id,
    schema_name,
    table_name,
    column_name,
    test_type
  FROM test_definitions
  WHERE test_suite_id = :TEST_SUITE_ID
    AND test_active = 'Y'
    AND history_calculation = 'PREDICT'
),
normalized_results AS (
  -- Step 2: Normalize definition IDs for autogenerated tests
  SELECT CASE
      WHEN r.auto_gen THEN d.id
      ELSE r.test_definition_id
    END AS test_definition_id,
    r.test_time,
    r.result_signal
  FROM test_results r
    LEFT JOIN filtered_defs d ON r.auto_gen = TRUE
    AND r.test_suite_id = d.test_suite_id
    AND r.schema_name = d.schema_name
    AND r.table_name IS NOT DISTINCT FROM d.table_name
    AND r.column_names IS NOT DISTINCT FROM d.column_name
    AND r.test_type = d.test_type
  WHERE r.test_suite_id = :TEST_SUITE_ID
)
SELECT test_definition_id,
  test_time,
  CASE
    WHEN result_signal ~ '^-?[0-9]*\.?[0-9]+$' THEN result_signal::NUMERIC
    ELSE NULL
  END AS result_signal
FROM normalized_results
WHERE test_definition_id IN (SELECT id FROM filtered_defs)
ORDER BY test_time;
